<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>み旨の裏庭 - サイト内検索</title>

  <!-- CSS（デザイン調整） -->
  <style>
    body {
      font-family: sans-serif;
      max-width: 1000px;
      margin: 2em auto;
      padding: 0 1em;
      line-height: 1.7;
    }
    #search-area {
      margin-bottom: 20px;
      text-align: center;
    }
    #search-input {
      width: 60%;
      padding: 12px;
      font-size: 20px;
      border: 2px solid #ccc;
      border-radius: 8px;
    }
    #search-btn {
      padding: 12px 20px;
      font-size: 20px;
      margin-left: 10px;
      border: none;
      border-radius: 8px;
      background-color: #66aaff;
      color: white;
      cursor: pointer;
    }
    #search-btn:hover {
      background-color: #5599dd;
    }
    #search-count {
      margin: 10px 0;
      font-size: 18px;
      color: #555;
      text-align: center;
    }
    #search-results {
      list-style: none;
      padding: 0;
    }
    #search-results li {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 10px;
      background: #f9f9f9;
    }
    .search-title {
      font-size: 22px;
      color: #0077cc;
      text-decoration: none;
    }
    .search-title:hover {
      text-decoration: underline;
    }
    .search-snippet {
      display: block;
      margin-top: 8px;
      font-size: 16px;
      color: #333;
    }
    mark {
      background-color: yellow;
    }
  </style>

  <!-- ライブラリ読み込み -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

</head>
<body>

<h1>み旨の裏庭 - サイト内検索</h1>

<div id="search-area">
  <input id="search-input" type="text" placeholder="検索ワードを入力" />
  <button id="search-btn">検索</button>
</div>

<div id="search-count"></div>
<ul id="search-results"></ul>

<!-- インクリメンタル全文検索スクリプト -->
<script type="module">
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const searchResults = document.getElementById('search-results');
const searchCount = document.getElementById('search-count');

let indexData = [];

// 最初にlight-index.jsonをロード
fetch('light-index.json')
  .then(res => res.json())
  .then(data => {
    indexData = data;

    const fuse = new Fuse(indexData, {
      keys: ['title'],
      threshold: 0.4
    });

    function createSnippet(text, keyword) {
      const idx = text.indexOf(keyword);
      if (idx >= 0) {
        const start = Math.max(0, idx - 20);
        const end = Math.min(text.length, idx + keyword.length + 30);
        return (start > 0 ? "..." : "") + text.slice(start, end) + (end < text.length ? "..." : "");
      } else {
        return text.length > 100 ? text.slice(0, 100) + "..." : text;
      }
    }

    function highlight(text, keyword) {
      const regex = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      return text.replace(regex, match => `<mark>${match}</mark>`);
    }

    function doSearch() {
      const query = searchInput.value.trim();
      if (!query) return;

      const results = fuse.search(query);

      searchResults.innerHTML = '';
      searchCount.textContent = `検索結果: ${results.length}件`;

      if (results.length === 0) {
        searchResults.innerHTML = '<li>検索結果がありません</li>';
      } else {
        results.forEach(result => {
          const item = result.item;
          fetch(item.url)
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, "text/html");
              const bodyText = doc.body.innerText;
